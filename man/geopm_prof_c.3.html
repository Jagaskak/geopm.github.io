<!DOCTYPE html>
<html>
<head>
  <meta http-equiv='content-type' value='text/html;charset=utf8'>
  <meta name='generator' value='Ronn/v0.7.3 (http://github.com/rtomayko/ronn/tree/0.7.3)'>
  <title>geopm_prof_c(3) - geopm application profiling structure</title>
  <style type='text/css' media='all'>
  /* style: man */
  body#manpage {margin:0}
  .mp {max-width:100ex;padding:0 9ex 1ex 4ex}
  .mp p,.mp pre,.mp ul,.mp ol,.mp dl {margin:0 0 20px 0}
  .mp h2 {margin:10px 0 0 0}
  .mp > p,.mp > pre,.mp > ul,.mp > ol,.mp > dl {margin-left:8ex}
  .mp h3 {margin:0 0 0 4ex}
  .mp dt {margin:0;clear:left}
  .mp dt.flush {float:left;width:8ex}
  .mp dd {margin:0 0 0 9ex}
  .mp h1,.mp h2,.mp h3,.mp h4 {clear:left}
  .mp pre {margin-bottom:20px}
  .mp pre+h2,.mp pre+h3 {margin-top:22px}
  .mp h2+pre,.mp h3+pre {margin-top:5px}
  .mp img {display:block;margin:auto}
  .mp h1.man-title {display:none}
  .mp,.mp code,.mp pre,.mp tt,.mp kbd,.mp samp,.mp h3,.mp h4 {font-family:monospace;font-size:14px;line-height:1.42857142857143}
  .mp h2 {font-size:16px;line-height:1.25}
  .mp h1 {font-size:20px;line-height:2}
  .mp {text-align:justify;background:#fff}
  .mp,.mp code,.mp pre,.mp pre code,.mp tt,.mp kbd,.mp samp {color:#131211}
  .mp h1,.mp h2,.mp h3,.mp h4 {color:#030201}
  .mp u {text-decoration:underline}
  .mp code,.mp strong,.mp b {font-weight:bold;color:#131211}
  .mp em,.mp var {font-style:italic;color:#232221;text-decoration:none}
  .mp a,.mp a:link,.mp a:hover,.mp a code,.mp a pre,.mp a tt,.mp a kbd,.mp a samp {color:#0000ff}
  .mp b.man-ref {font-weight:normal;color:#434241}
  .mp pre {padding:0 4ex}
  .mp pre code {font-weight:normal;color:#434241}
  .mp h2+pre,h3+pre {padding-left:0}
  ol.man-decor,ol.man-decor li {margin:3px 0 10px 0;padding:0;float:left;width:33%;list-style-type:none;text-transform:uppercase;color:#999;letter-spacing:1px}
  ol.man-decor {width:100%}
  ol.man-decor li.tl {text-align:left}
  ol.man-decor li.tc {text-align:center;letter-spacing:4px}
  ol.man-decor li.tr {text-align:right;float:right}
  </style>
</head>
<!--
  The following styles are deprecated and will be removed at some point:
  div#man, div#man ol.man, div#man ol.head, div#man ol.man.

  The .man-page, .man-decor, .man-head, .man-foot, .man-title, and
  .man-navigation should be used instead.
-->
<body id='manpage'>
  <div class='mp' id='man'>

  <div class='man-navigation' style='display:none'>
    <a href="#NAME">NAME</a>
    <a href="#SYNOPSIS">SYNOPSIS</a>
    <a href="#DESCRIPTION">DESCRIPTION</a>
    <a href="#EXAMPLE">EXAMPLE</a>
    <a href="#ERRORS">ERRORS</a>
    <a href="#COPYRIGHT">COPYRIGHT</a>
    <a href="#SEE-ALSO">SEE ALSO</a>
  </div>

  <ol class='man-decor man-head man head'>
    <li class='tl'>geopm_prof_c(3)</li>
    <li class='tc'></li>
    <li class='tr'>geopm_prof_c(3)</li>
  </ol>

  <h2 id="NAME">NAME</h2>
<p class="man-name">
  <code>geopm_prof_c</code> - <span class="man-whatis">geopm application profiling structure</span>
</p>

<h2 id="SYNOPSIS">SYNOPSIS</h2>

<p><strong>#include <a href="https://github.com/geopm/geopm/blob/dev/src/geopm.h">&lt;geopm.h></a></strong></p>

<p><code>Link with -lgeopm</code></p>

<dl>
<dt><code>int geopm_prof_region(</code></dt><dd><p><code>const char *</code><em>region_name</em>, <br />
<code>uint64_t</code> <em>hint</em>, <br />
<code>uint64_t *</code><em>region_id</em>);</p></dd>
<dt><code>int geopm_prof_enter(</code></dt><dd><p><code>uint64_t</code> <em>region_id</em>);</p></dd>
<dt><code>int geopm_prof_exit(</code></dt><dd><p><code>uint64_t</code> <em>region_id</em>);</p></dd>
<dt><code>int geopm_prof_progress(</code></dt><dd><p><code>uint64_t</code> <em>region_id</em>, <br />
<code>double</code> <em>fraction</em>);</p></dd>
<dt><code>int geopm_prof_epoch(</code></dt><dd><p>`void);</p></dd>
<dt><code>int geopm_prof_disable(</code></dt><dd><p><code>const char *</code><em>feature_name</em>);</p></dd>
<dt><code>int geopm_tprof_create(</code></dt><dd><p><code>int</code> <em>num_thread</em>, <br />
<code>size_t</code> <em>num_iter</em>, <br />
<code>size_t</code> <em>chunk_size</em>, <br />
<code>struct geopm_tprof_c **</code><em>tprof</em>);</p></dd>
<dt><code>int geopm_tprof_destroy(</code></dt><dd><p><code>struct geopm_tprof_c *</code><em>tprof</em>);</p></dd>
<dt><code>int geopm_tprof_increment(</code></dt><dd><p><code>struct geopm_tprof_c *</code><em>tprof</em>, <br />
<code>uint64_t</code> <em>region_id</em>, <br />
<code>int</code> <em>thread_idx</em>);</p></dd>
</dl>


<h2 id="DESCRIPTION">DESCRIPTION</h2>

<p>The functions described here enable application feedback to the
control algorithm for identifying regions of code, progress within
regions, and iterations through loops that contain inter-node
synchronization points in the application.  Regions of code define
periods in the application during which control parameters are tuned
with the expectation that control parameters for a region can be
optimized independently of other regions.  In this way a region is
associated with a set of control parameters which can be optimized,
and future time intervals associated with the same region will benefit
from the application of control parameters which were determined from
tuning within previous occurrences of the region.  There are two
competing motivations for defining a region within the application.
The first is to identify a section of code that has distinct compute,
memory or network characteristics.  The second is to avoid defining
these regions such that they are nested within each other, as nested
regions are ignored, and only the outer most region is used for tuning
when nesting occurs.  Identifying progress within a region can be used
to alleviate load imbalance in the application under the assumption
that the region is bulk synchronous.  Under the assumption that the
application employs an iterative algorithm which synchronizes
periodically the user can alleviate load imbalance on larger time
scales than the regions provide.  This is done by marking iterations
through an outer loop in the application, the "epoch".</p>

<dl>
<dt><code>geopm_prof_region</code>()</dt><dd><p>registers an application region.  The <em>region_name</em> and
<em>hint</em> are input parameters, and the <em>region_id</em> is output.
The <em>region_id</em> can be used with <code>geopm_prof_enter</code>(),
<code>geopm_prof_exit</code>(), <code>geopm_prof_progress</code>(), and
<code>geopm_tprof_progress</code>() to referrence the region.  If the region
name has been previously registered, a call to this function will
set the <em>region_id</em> but the state associated with the region is
unmodified.  The <em>region_name</em> is used to determine the output
<em>region_id</em> and is also displayed in the profiling report to
identify the region.  The <em>hint</em> is one of the values given
by the geopm_region_hint_e enum defined in <em>geopm.h</em> which
determines the initial control settings.  The following hints are
supported: <code>GEOPM_REGION_HINT_UNKNOWN</code>,
<code>GEOPM_REGION_HINT_COMPUTE</code>, <code>GEOPM_REGION_HINT_MEMORY</code>,
<code>GEOPM_REGION_HINT_NETWORK</code>, <code>GEOPM_REGION_HINT_IO</code>,
<code>GEOPM_REGION_HINT_SERIAL</code>, <code>GEOPM_REGION_HINT_PARALLEL</code>,
<code>GEOPM_REGION_HINT_IGNORE</code>.</p></dd>
<dt><code>geopm_prof_enter</code>()</dt><dd><p>is called by the compute application to mark the beginning of the
profiled compute region associated with the <em>region_id</em>. If this
call is made after entering a different region, but before exiting
that region, the call is ignored and an error code is returned
(i.e. nested regions are ignored).</p></dd>
<dt><code>geopm_prof_exit</code>()</dt><dd><p>is called by the compute application to mark the end of a compute
region.  If this region is nested then the call is ignored and an
error code is returned.</p></dd>
<dt><code>geopm_prof_progress</code>()</dt><dd><p>is called by compute application in single threaded context to
signal the fractional progress, <em>fraction</em> through the work
required to complete the region where <em>fraction</em> is between 0 and 1.
If the <em>region_id</em> does not match the <em>region_id</em> of the last
call to geopm_prof_prof_enter() which was not nested, then this
call is ignored and an error code is returned.</p></dd>
<dt><code>geopm_prof_epoch</code>()</dt><dd><p>is called once for each pass through a computational loop
containing inter-node synchronization events.  This call acts as a
beacon signal emitted by each MPI rank as it begins a loop
iteration.  The divergence in the elapsed time between calls by
different MPI ranks is interpreted as an imbalance to be corrected
by the runtime.  This function may be called at different places
in an application, but it should not be used to mark a loop that
is nested inside of another loop which is also marked.  It is
important to note that this call acts as a barrier between ranks
running within the same compute node.</p></dd>
<dt><code>geopm_prof_disable</code>()</dt><dd><p>is called at application start up to disable a profiling feature.
By default all profiling features available on the system are
enabled.  The set of all possible values for <em>feature_name</em> are:
"instr", "flop", and "joules".  This API is not currently
implemented.</p></dd>
<dt><code>geopm_tprof_create</code>()</dt><dd><p>creates a thread profiling object, <em>tprof</em>, which extends the
functionality of the profiling interface to report progress within
threaded regions.  The interface assumes a fixed number of
threads, <em>num_thread</em>, which are performing work sharing on a list
of tasks <em>num_iter</em> long (e.g. an omp parallel for loop with
<em>num_iter</em> loops).  In the specific case of an OpenMP for loop
statically scheduled with a chunk size then the <em>chunk_size</em>
arguement can be specified to be non-zero and the work
distribution amung threads is explicitly calculated while the
minimum progress of any thread is reported.  In all other
threading models <em>chunk_size</em> should be specified to be zero and
progress is aggregated and the mean progress is reported.</p></dd>
<dt><code>geopm_tprof_destroy</code>()</dt><dd><p>releases all resources associated with the <em>tprof</em> object.  The
<em>tprof</em> object should be created and destroyed for each process
entry into a thread parallel region: the <em>tprof</em> object cannot be
reused.</p></dd>
<dt><code>geopm_tprof_increment</code>()</dt><dd><p>is called after a thread has completed each work unit to report
progress.  The <em>tprof</em> thread profiling object is passed as the
first argument. The region identifier returned by
<code>geopm_prof_region</code>() is passed as the second argument,
<em>region_id</em>.  The last argument is the thread index which is in
the range of [0, 1, ..., <em>num_thread</em> - 1] where <em>num_thread</em> is
the parameter passed when the <em>tprof</em> was created.  This index
uniquely identifies the thread that is reporting progress.  When
using the <code>geopm_tprof_increment</code>() interface to report progress,
it is incorrect to also call the <code>geopm_prof_progress</code>()
interface for the same region.</p></dd>
</dl>


<h2 id="EXAMPLE">EXAMPLE</h2>

<pre><code>#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;
#include &lt;stdint.h&gt;
#include &lt;mpi.h&gt;
#include &lt;omp.h&gt;

#include "geopm.h"


int main(int argc, char **argv)
{
    int chunk_size = 0;
    int err = 0;
    int index = 0;
    int rank = 0;
    int num_iter = 100000000;
    double sum = 0.0;
    struct geopm_tprof_c *tprof = NULL;
    int num_thread = 0;
    int thread_idx = 0 ;
    uint64_t region_id = 0;

    err = MPI_Init(&amp;argc, &amp;argv);
    if (!err) {
#pragma omp parallel
{
        num_thread = omp_get_num_threads();
}
        chunk_size = num_iter / num_thread;
        if (num_iter % num_thread) {
            ++chunk_size;
        }
        err = geopm_tprof_create(num_thread, num_iter, chunk_size, &amp;tprof);
    }
    if (!err) {
        err = geopm_prof_region("loop_0", GEOPM_REGION_HINT_UNKNOWN, &amp;region_id);
    }
    MPI_Barrier(MPI_COMM_WORLD);
    if (!err) {
        err = geopm_prof_enter(region_id);
    }
    if (!err) {
#pragma omp parallel default(shared) private(thread_idx, index)
{
        thread_idx = omp_get_thread_num();
#pragma omp for reduction(+:sum) schedule(static, chunk_size)
        for (index = 0; index &lt; num_iter; ++index) {
            sum += (double)index;
            geopm_tprof_increment(tprof, region_id, thread_idx);
        }
}
        err = geopm_prof_exit(region_id);
    }
    if (!err) {
        err = MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);
    }
    if (!err &amp;&amp; !rank) {
        printf("sum = %e\n\n", sum);
    }

    int tmp_err = MPI_Finalize();

    return err ? err : tmp_err;
}
</code></pre>

<h2 id="ERRORS">ERRORS</h2>

<p>All functions described on this man page return an error code.  See
<strong><a class="man-ref" href="geopm_error.3.html">geopm_error<span class="s">(3)</span></a></strong> for a full description of the error numbers and how
to convert them to strings.</p>

<h2 id="COPYRIGHT">COPYRIGHT</h2>

<p>Copyright (C) 2015, 2016, 2017, Intel Corporation. All rights reserved.</p>

<h2 id="SEE-ALSO">SEE ALSO</h2>

<p><strong><a class="man-ref" href="geopm.7.html">geopm<span class="s">(7)</span></a></strong>,
<strong><a class="man-ref" href="geopm_ctl_c.3.html">geopm_ctl_c<span class="s">(3)</span></a></strong>,
<strong><a class="man-ref" href="geopm_error.3.html">geopm_error<span class="s">(3)</span></a></strong>,
<strong><a class="man-ref" href="geopm_fortran.3.html">geopm_fortran<span class="s">(3)</span></a></strong>,
<strong><a class="man-ref" href="geopm_omp.3.html">geopm_omp<span class="s">(3)</span></a></strong>,
<strong><a class="man-ref" href="geopm_policy_c.3.html">geopm_policy_c<span class="s">(3)</span></a></strong>,
<strong><a class="man-ref" href="geopm_version.3.html">geopm_version<span class="s">(3)</span></a></strong>,
<strong><a class="man-ref" href="geompsrun.1.html">geopmsrun<span class="s">(1)</span></a></strong>,
<strong><a class="man-ref" href="geopmaprun.1.html">geopmaprun<span class="s">(1)</span></a></strong>,
<strong><a class="man-ref" href="geopmplotter.1.html">geopmplotter<span class="s">(1)</span></a></strong>,
<strong><a class="man-ref" href="geopmctl.1.html">geopmctl<span class="s">(1)</span></a></strong>,
<strong><a class="man-ref" href="geopmpolicy.1.html">geopmpolicy<span class="s">(1)</span></a></strong>,</p>


  <ol class='man-decor man-foot man foot'>
    <li class='tl'>Intel Corporation</li>
    <li class='tc'>May 2017</li>
    <li class='tr'>geopm_prof_c(3)</li>
  </ol>

  </div>
</body>
</html>
